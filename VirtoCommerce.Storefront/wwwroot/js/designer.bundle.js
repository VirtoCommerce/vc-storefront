!function(e){var t={};function s(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(n,r,function(t){return e[t]}.bind(null,r));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=5)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(14),r=s(1);t.BaseHandler=class{get renderer(){return r.ServiceLocator.getRenderer()}execute(e,t){let s=this.getViewModel(e.content.id,t);s||(s=this.createViewModel(e.content)),this.executeInternal(e,t,s)}executeInternal(e,t,s){}reloadBlock(e){return r.ServiceLocator.getHttp().post(e)}generateId(e){return e?`instance${e}`:"preview-instance"}createViewModel(e,t=!1){const s=new n.BlockViewModel;return Object.assign(s,{id:this.generateId(e.id),source:e,element:null,isPreview:t,htmlString:null,selected:!1,hidden:!!e.hidden}),s}getViewModel(e,t){const s=this.generateId(e);return t.find(e=>e.id===s)}deselectAll(e){e.forEach(e=>e.selected=!1)}clearPreview(e){e.map((e,t)=>({item:e,index:t})).filter(e=>e.item.isPreview).forEach(t=>{e.splice(t.index,1),t.item.element.remove()})}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(6),r=s(7),i=s(2),o=s(8),l=s(9),c=s(10),d=s(11),h=s(3),a=s(26),u=s(27);t.ServiceLocator=class{static createApp(){return this._container=document.getElementById("designer-preview"),this._app||(this._app=new a.App(this.getDispatcher()))}static getPreviewInteractor(){return this._interactor||(this._interactor=new r.PreviewInteractor(this.getDndInteractor())),this._interactor}static getDndInteractor(){return this._dnd||(this._dnd=new n.DndInteractor(this._container,()=>this._app.getList()))}static getEventBus(){return this._eventBus||(this._eventBus=new i.EventsBus)}static getHttp(){return this._http||(this._http=new o.HttpService(h.Environment.RenderBlockApiUrl))}static getMessages(){return this._messages||(this._messages=new u.MessagesService(h.Environment.DesignerUrl))}static getRenderer(){return this._renderer||(this._renderer=new c.Renderer(this._container))}static getFactory(){return this._factory||(this._factory=new d.HandlersFactory)}static getDispatcher(){return this._dispatcher||(this._dispatcher=new l.EventsDispatcher(this.getFactory(),this.getMessages()))}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(){this.subscribers={}}publish(e,t,s){this.subscribers[e]&&this.subscribers[e].forEach(e=>{e(t,s)})}subscribe(e,t){return this.subscribers[e]||(this.subscribers[e]=[]),this.subscribers[e].push(t),()=>{const s=this.subscribers[e].indexOf(t);-1!==s&&this.subscribers[e].splice(s,1)}}}n.Current=new n,t.EventsBus=n},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Environment={RenderBlockApiUrl:"/designer-preview/block",DesignerUrl:""}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.measureElement=function(e){const t=e,s=t.offsetWidth,n=t.offsetHeight;let r={},i=0,o=0;var l=function(e){if(!e)return r={top:t.offsetTop+o,left:t.offsetLeft+i,height:n,width:s};i+=e.offsetLeft,o+=e.offsetTop,l(e.offsetParent)};return l(t.offsetParent),r}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(3),r=s(1);document.addEventListener("DOMContentLoaded",()=>{console.log("run preview window"),n.Environment.DesignerUrl=window.__designer_preview__,r.ServiceLocator.createApp().run()}),window.addEventListener("click",e=>{e.preventDefault()})},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(4),r=s(2);t.DndInteractor=class{constructor(e,t){this.container=e,this.listAccessor=t,this.delta=10,this.startMouseY=null,this.oldStyle={},this.onDragStarted=(()=>{}),this.onDragFinished=(e=>{}),this.onSwapBlocks=((e,t)=>{}),this.placeholder=document.createElement("div"),this.placeholder.style.backgroundColor="#eeeeee",window.addEventListener("mousemove",e=>{this.isPressed&&(this.dragStarted?this.drag(e):this.startDrag(e))}),window.addEventListener("mouseup",e=>{this.dragStarted&&this.releaseDrag(),this.isPressed=!1})}mouseDown(e,t){this.isPressed=!0,this.model=t,this.startMouseY=e.pageY,this.elementRect=n.measureElement(t.element),this.placeholder.style.height=this.elementRect.height+"px",this.list=this.listAccessor();const s=n.measureElement(this.container);this.minY=s.top,this.maxY=s.top+s.height,this.rects=this.list.map(e=>n.measureElement(e.element))}startDrag(e){Math.abs(e.pageY-this.startMouseY)>=this.delta&&(this.dragStarted=!0,this.onDragStarted(),this.container.replaceChild(this.placeholder,this.model.element),document.body.appendChild(this.model.element),this.saveStyle(),this.styleDraggedBlock(),this.container.style.height=n.measureElement(this.container).height+"px")}drag(e){const t=Math.max(Math.min(e.pageY,this.maxY),this.minY);this.model.element.style.top=t-this.startMouseY+this.elementRect.top+"px";const s=this.rects.findIndex(e=>e!==this.model&&e.top<t&&e.top+e.height>t),n=this.list.indexOf(this.model);if(-1===n||-1===s||n===s)return;const i=this.rects[s].top+this.rects[s].height/2;if(n>s&&t<=i||n<=s&&t>i){console.log(n,s,t,this.rects[s]),this.container.removeChild(this.placeholder);const e=this.container.children.item(s);this.container.insertBefore(this.placeholder,e);const i={content:{id:this.model.id,currentIndex:n,newIndex:s}};r.EventsBus.Current.publish("dnd.swap-blocks",i,this),console.log("swapped")}}releaseDrag(){this.dragStarted&&(console.log("release drag",this.model),document.body.removeChild(this.model.element),this.restoreStyles(),this.container.replaceChild(this.model.element,this.placeholder),this.elementRect=null,this.startMouseY=null,this.onDragFinished(this.model),this.oldStyle={},this.container.style.height=""),this.dragStarted=!1,this.isPressed=!1,this.model=null}saveStyle(){this.oldStyle.left=this.model.element.style.left,this.oldStyle.top=this.model.element.style.top,this.oldStyle.width=this.model.element.style.width,this.oldStyle.height=this.model.element.style.height,this.oldStyle.postion=this.model.element.style.position,this.oldStyle.backgroundColor=this.model.element.style.backgroundColor,this.oldStyle.border=this.model.element.style.border,this.oldStyle.opacity=this.model.element.style.opacity}restoreStyles(){this.model.element.style.position=this.oldStyle.position||"static",this.model.element.style.left=this.oldStyle.left,this.model.element.style.top=this.oldStyle.top,this.model.element.style.width=this.oldStyle.width,this.model.element.style.height=this.oldStyle.height,this.model.element.style.backgroundColor=this.oldStyle.backgroundColor,this.model.element.style.border=this.oldStyle.border,this.model.element.style.opacity=this.oldStyle.opacity}styleDraggedBlock(){this.model.element.style.left=this.elementRect.left+"px",this.model.element.style.top=this.elementRect.top+"px",this.model.element.style.width=this.elementRect.width+"px",this.model.element.style.height=this.elementRect.height+"px",this.model.element.style.overflow="hidden",this.model.element.style.position="absolute",this.model.element.style.backgroundColor="#fefefe",this.model.element.style.border="3px solid #33ada9",this.model.element.style.opacity="0.5"}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(1),r=s(4);t.PreviewInteractor=class{constructor(e){this.dnd=e,this.borderWidth=3,this.hoveredViewModel=null,this.selectedViewModel=null,this.inactive=!1,this.createHoverElement(),this.createSelectElement(),this.dnd.onDragStarted=(()=>{this.inactive=!0,this.hideHoverElement(),this.hideSelectElement()}),this.dnd.onDragFinished=(()=>{this.inactive=!1})}hover(e){this.inactive||(null==e||this.selectedViewModel==e?this.hideHoverElement():(this.hoveredViewModel=e,this.hoverElement.style.display="block",this.placeElementHover(e.element,this.hoverElement)))}select(e){this.inactive||(this.selectedViewModel=e,this.selectElement.style.display="block",this.placeElementHover(e.element,this.selectElement))}deselect(){this.hideSelectElement()}scrollTo(e){if(this.inactive)return;const t=r.measureElement(e.element).top-window.innerHeight/10;window.scroll({top:t,behavior:"smooth"})}hideSelectElement(){this.selectedViewModel=null,this.selectElement.style.display="none"}hideHoverElement(){this.hoveredViewModel=null,this.hoverElement.style.display="none"}createHoverElement(){const e=this.createShadowElement();return e.style.border=`${this.borderWidth}px dotted #33ada9`,e.addEventListener("mouseleave",()=>{null!=this.hoveredViewModel&&this.hoveredViewModel.onLeave(),this.hideHoverElement()}),e.addEventListener("click",e=>{this.select(this.hoveredViewModel),this.hoveredViewModel.onSelect(),this.hideHoverElement()}),e.addEventListener("mousedown",e=>{this.dnd.mouseDown(e,this.hoveredViewModel)}),this.hoverElement=e,e}createSelectElement(){const e=this.createShadowElement();return e.style.border=`${this.borderWidth}px solid #33ada9`,e.addEventListener("click",e=>{n.ServiceLocator.getDispatcher().selectBlock(null)}),e.addEventListener("mousedown",e=>{this.dnd.mouseDown(e,this.selectedViewModel)}),this.selectElement=e,e}createShadowElement(){const e=document.createElement("div");return e.style.position="absolute",e.style.display="none",e.style.zIndex="10000",document.body.appendChild(e),e}placeElementHover(e,t){if(!e)return;const s=r.measureElement(e);this.borderWidth,t.style.top=s.top+0+"px",t.style.left=s.left+0+"px",t.style.height=s.height-0+"px",t.style.width=s.width-0+"px",t.style.display="block"}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.HttpService=class{constructor(e){this.endpoint=e}get(){}postTo(e,t){return new Promise((s,n)=>{const r=new XMLHttpRequest;r.open("post",e),r.setRequestHeader("Accept","application/json, text/javascript, text/plain"),r.setRequestHeader("Cache-Control","no-cache"),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("X-XSRF-TOKEN",this.getToken()),r.send(JSON.stringify(t)),r.onload=(e=>{s(r.responseText.trim())})})}post(e){return this.postTo(this.endpoint,e)}getToken(){if(!this.token){for(var e=document.cookie.split(";"),t=null,s=0;s<e.length;s++){var n=e[s];if(n.startsWith(" XSRF-TOKEN")||n.startsWith("XSRF-TOKEN")){t=n.substr(n.indexOf("XSRF-TOKEN=")+11);break}}this.token=t}return this.token}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(2);t.EventsDispatcher=class{constructor(e,t){this.factory=e,this.messages=t,this.handleMessage=(()=>{}),n.EventsBus.Current.subscribe("dnd.swap-blocks",(e,t)=>(this.handleMessage(this.factory.get("swap"),e),this.swapBlock(e),null))}run(){window.addEventListener("message",e=>{e.data&&this.handleEvent(e.data)})}selectBlock(e){e&&e.source?(this.handleEvent({type:"select",content:e.source}),this.messages.selectBlock(e.source),e.selected=!1):(this.handleEvent({type:"select",content:{id:0}}),this.messages.selectBlock(null),e&&(e.selected=!0))}highlightBlock(e){this.messages.blockHover(e.source)}unlightBlock(){this.messages.blockHover({id:0})}swapBlock(e){this.messages.swapBlocks(e)}handleEvent(e){const t=this.factory.get(e.type);t&&this.handleMessage(t,e)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(1);t.Renderer=class{constructor(e){this.container=e,this.interactor=n.ServiceLocator.getPreviewInteractor()}add(e){e.element=this.createElement(e),this.container.append(e.element),e.hidden&&(e.element.style.display="none")}update(e){const t=e.element;t&&(e.element=this.createElement(e),this.container.replaceChild(e.element,t),this.interactor.select(e),this.hover(e))}insert(e,t){e.element=this.createElement(e);const s=this.container.children.item(t);this.container.insertBefore(e.element,s),e.hidden&&(e.element.style.display="none")}select(e=null){null===e||e.hidden||!e.selected?this.interactor.deselect():this.interactor.select(e)}scrollTo(e){e&&e.element&&!e.hidden&&this.interactor.scrollTo(e)}hover(e=null){null===e||e.hidden||e.selected?this.interactor.hover(null):this.interactor.hover(e)}createElement(e){const t=document.createElement("div");t.innerHTML=`<div>${e.htmlString}</div>`;const s=t.firstChild;return s.style.userSelect="none",e.isPreview||(s.addEventListener("mouseover",t=>{this.interactor.hover(e),e.onHover()}),s.addEventListener("click",()=>e.onSelect())),s}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(12);class r{get(e){return r.handlers.find(t=>t.key==e)}}r.handlers=[new n.AddHandler,new n.UpdateHandler,new n.CloneHandler,new n.HideHandler,new n.ShowHandler,new n.RemoveHandler,new n.PreviewHandler,new n.SelectHandler,new n.SwapHandler,new n.ReloadHandler,new n.PageHandler,new n.HoverHandler],t.HandlersFactory=r},function(e,t,s){"use strict";function n(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),n(s(13)),n(s(15)),n(s(16)),n(s(17)),n(s(18)),n(s(19)),n(s(20)),n(s(21)),n(s(22)),n(s(23)),n(s(24)),n(s(25))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.AddHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="add"}executeInternal(e,t,s){this.clearPreview(t),t.push(s),s.selected=!0,this.reloadBlock(s.source).then(e=>{s.htmlString=e,this.renderer.add(s),this.renderer.select(s)})}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(1);t.BlockViewModel=class{constructor(){this.onSelect=(()=>{this.eventsDispatcher.selectBlock(this)}),this.onLeave=(()=>{this.eventsDispatcher.unlightBlock()}),this.onHover=(()=>{this.eventsDispatcher.highlightBlock(this)})}get eventsDispatcher(){return n.ServiceLocator.getDispatcher()}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.CloneHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="clone"}execute(e,t){this.deselectAll(t);const s=this.getViewModel(e.content.source,t),n=Object.assign({},s.source,{id:e.content.destination}),r=this.createViewModel(n);r.htmlString=s.htmlString,r.hidden=s.hidden,r.selected=!0;const i=t.indexOf(s);t.splice(i+1,0,r),this.renderer.insert(r,i+1),this.renderer.select(r),setTimeout(()=>{this.renderer.scrollTo(r)},300)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.HideHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="hide"}executeInternal(e,t,s){s.hidden=!0,s.element.style.display="none"}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.HoverHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="hover"}execute(e,t){this.deselectAll(t),e.content.id?super.execute(e,t):this.renderer.hover()}executeInternal(e,t,s){this.renderer.hover(s)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.PreviewHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="preview"}execute(e,t){if(this.clearPreview(t),e.content){const s=this.createViewModel(e.content,!0);t.push(s),this.reloadBlock(s.source).then(e=>{s.htmlString=e,this.renderer.add(s),this.renderer.scrollTo(s)})}}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.RemoveHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="remove"}executeInternal(e,t,s){const n=t.indexOf(s);t.splice(n,1),s.element.remove(),this.renderer.select()}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.SelectHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="select"}execute(e,t){this.deselectAll(t),this.clearPreview(t),0===e.content.id?this.renderer.select():super.execute(e,t)}executeInternal(e,t,s){s.selected=!0,this.renderer.select(s),this.renderer.scrollTo(s)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.ShowHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="show"}executeInternal(e,t,s){s.hidden=!1,s.element.style.display="block",this.renderer.scrollTo(s)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.SwapHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="swap"}execute(e,t){const s=t[e.content.currentIndex];t.splice(e.content.currentIndex,1),t.splice(e.content.newIndex,0,s),t[e.content.currentIndex].element.parentElement===t[e.content.newIndex].element.parentElement&&(s.element.remove(),this.renderer.insert(s,e.content.newIndex))}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.UpdateHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="update"}executeInternal(e,t,s){s.source=e.content,this.reloadBlock(s.source).then(e=>{s.htmlString=e,this.renderer.update(s),this.renderer.select(s)})}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.ReloadHandler=class extends n.BaseHandler{constructor(){super(...arguments),this.key="reload"}execute(e,t){document.location.reload()}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(1),r=s(0);t.PageHandler=class extends r.BaseHandler{constructor(){super(...arguments),this.key="page"}execute(e,t){console.log(e),e.content.blocks.forEach(e=>{const s=this.createViewModel(e);t.push(s)}),Promise.all(t.map(e=>this.reloadBlock(e.source).then(t=>(e.htmlString=t,t)))).then(()=>{t.forEach(e=>{this.renderer.add(e)}),n.ServiceLocator.getMessages().renderComplete()})}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.App=class{constructor(e){this.dispatcher=e,this.list=[]}run(){this.reloadResources(),this.dispatcher.handleMessage=((e,t)=>{e.execute(t,this.list)}),this.dispatcher.run()}getList(){return this.list}reloadResources(){var e="?preview_mode="+new URLSearchParams(window.location.search).get("preview_mode")+"&v="+(new Date).getTime(),t=document.getElementsByTagName("link");function s(e){var t=document.createElement("link");return t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e),t}for(var n=0;n<t.length;n++){var r=t[n];if(r.href&&r.href.startsWith(document.location.origin)&&r.href.endsWith(".css")){var i=s(r.href+e);const t=r.parentNode;t&&t.replaceChild(i,r)}}}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MessagesService=class{constructor(e){this.parentOrigin=e}renderComplete(){this.send("render-complete",null)}blockHover(e){this.send("hover",{id:e.id})}swapBlocks(e){this.send("swap",Object.assign({type:"swap"},e))}selectBlock(e){this.send("select",e?{id:e.id}:null)}ping(){this.send("ping",null)}send(e,t){const s=Object.assign({type:e},t);console.log("send to designer",s),window.parent.postMessage(s,this.parentOrigin)}}}]);
//# sourceMappingURL=designer.bundle.js.map